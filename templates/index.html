<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Zlecenia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function toggleDetails(id) {
      document.getElementById('details-' + id).classList.toggle('hidden');
    }
    function onFilterChange(select) {
      window.location.href = '/?filtr=' + select.value;
    }
  </script>
</head>
<body class="bg-gray-100 p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Zlecenia produkcyjne</h1>
    <div class="flex gap-4">
      <a href="/add" class="bg-green-600 text-white px-4 py-2 rounded">+ Dodaj zlecenie</a>
      <select onchange="onFilterChange(this)" class="border px-2 py-1 rounded">
        <option value="wszystkie" {% if filtr == 'wszystkie' %}selected{% endif %}>Wszystkie</option>
        <option value="w_produkcji" {% if filtr == 'w_produkcji' %}selected{% endif %}>W produkcji</option>
        <option value="zatrzymane" {% if filtr == 'zatrzymane' %}selected{% endif %}>Zatrzymane</option>
        <option value="zakonczone" {% if filtr == 'zakonczone' %}selected{% endif %}>ZakoÅ„czone</option>
      </select>
      <a href="/logout" class="text-red-600 hover:underline">Wyloguj</a>
    </div>
  </div>

  {% for z in zlecenia %}
    {% set kolor = 'bg-white' %}
    {% if z.zatrzymano %}
      {% set kolor = 'bg-red-100 border-red-500' %}
    {% elif z.zakonczone %}
      {% set kolor = 'bg-blue-100 border-blue-500' %}
    {% else %}
      {% set kolor = 'bg-green-100 border-green-500' %}
    {% endif %}

    <div class="border-l-4 {{ kolor }} p-4 rounded shadow mb-4">
      <div class="flex justify-between items-center cursor-pointer" onclick="toggleDetails({{ z.id }})">
        <div>
          <p class="font-bold text-lg">{{ z.numer_glowny }} â€” {{ z.klient }}</p>
          <p class="text-sm text-gray-700">Produkt: {{ z.produkt }}</p>
        </div>
        <button class="text-blue-600 hover:underline text-sm">SzczegÃ³Å‚y â–¼</button>
      </div>

      <div id="details-{{ z.id }}" class="mt-4 hidden">
        <div><strong>Papier:</strong>
          <ul class="list-disc ml-6">
            {% for p in z.papier %}
              <li>{{ p.typ }} â€“ {{ p.ilosc }}</li>
            {% endfor %}
          </ul>
        </div>

        <form method="POST" action="/update/{{ z.id }}" class="mt-3">
          <h4 class="font-semibold mb-2">Etapy:</h4>
          <div class="grid grid-cols-2 gap-2">
            {% for etap in z.etapy_niezbedne %}
              <label class="flex items-center">
                <input type="checkbox" name="wykonane_etapy" value="{{ etap }}"
                  {% if etap in z.wykonane_etapy %}checked{% endif %}
                  {% if z.zatrzymano %}disabled{% endif %} class="mr-2">
                {{ etap }}
                {% if z.historia_etapow.get(etap) %}
                  <span class="text-xs text-gray-500 ml-2">({{ z.historia_etapow[etap][:16].replace('T', ' ') }})</span>
                {% endif %}
              </label>
            {% endfor %}
          </div>
          {% if not z.zatrzymano and not z.zakonczone %}
            <button class="mt-3 bg-blue-600 text-white px-4 py-2 rounded">Zapisz etapy</button>
          {% endif %}
        </form>

        {% if not z.zatrzymano and not z.zakonczone and z.etapy_niezbedne|length == z.wykonane_etapy|length %}
          <form method="POST" action="/zakoncz/{{ z.id }}" class="mt-2">
            <button class="bg-green-700 text-white px-4 py-2 rounded">âœ… ZakoÅ„cz zlecenie</button>
          </form>
        {% endif %}

        {% if z.zatrzymano %}
          <p class="text-red-600 mt-4 font-semibold">â›” Zatrzymano</p>
          <p class="text-sm">{{ z.powod_zatrzymania }}</p>
          <form method="POST" action="/wznÃ³w/{{ z.id }}" class="mt-2">
            <button class="bg-yellow-500 text-white px-4 py-1 rounded">ðŸ”„ WznÃ³w zlecenie</button>
          </form>
        {% elif not z.zakonczone %}
          <form method="POST" action="/zatrzymaj/{{ z.id }}" class="mt-4">
            <textarea name="powod" rows="2" class="w-full border rounded px-3 py-2 mb-2" placeholder="PowÃ³d zatrzymania..."></textarea>
            <button class="bg-red-600 text-white px-4 py-2 rounded">â›” Zatrzymaj</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</body>
</html>
